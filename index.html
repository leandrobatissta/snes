<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>SNES Web – Super Mario World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    body{margin:0;background:#111;color:#eee;font:15px/1.5 system-ui}
    header,footer{padding:12px 16px;background:#222}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    button,input[type=file]{background:#444;border:1px solid #666;color:#eee;
      padding:10px 14px;border-radius:6px;cursor:pointer;font-size:14px}
    button:hover{background:#555}
    #gameHost{width:100%;max-width:960px;aspect-ratio:4/3;background:#000;
      margin:12px auto;border-radius:8px;overflow:hidden;border:1px solid #333}
    #game{width:100%;height:100%}
    .info{margin-top:20px;background:#1a1a1a;padding:12px;border-radius:8px}
    code{background:#333;padding:2px 5px;border-radius:4px}
    @media (max-width:768px){
      .toolbar{flex-direction:column}
      button,input[type=file]{width:100%}
      #gameHost{max-width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap"><strong>SNES Web – Super Mario World</strong></div>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <label>
        <input id="romInput" type="file" accept=".smc,.sfc,.zip,.7z" />
        Carregar ROM…
      </label>
      <button id="btnSave">💾 Salvar (navegador)</button>
      <button id="btnLoad">📂 Carregar (navegador)</button>
      <button id="btnExport">⬇️ Exportar Save</button>
      <button id="btnImport">⬆️ Importar Save</button>
      <input id="stateInput" type="file" accept=".state" style="display:none" />
      <button id="btnPause">⏯️ Pausar</button>
      <button id="btnFullscreen">⛶ Tela cheia</button>
    </div>

    <div id="gameHost"><div id="game"></div></div>

    <div class="info">
      <h3>🎮 Controles</h3>
      <ul>
        <li>Direcionais: <code>Setas</code></li>
        <li>A / B / X / Y: <code>Z</code> / <code>X</code> / <code>A</code> / <code>S</code></li>
        <li>L / R: <code>Q</code> / <code>W</code></li>
        <li>Start: <code>Enter</code> &nbsp; Select: <code>Shift direito</code></li>
        <li>Atalhos: <code>F</code> (tela cheia), <code>P</code> (pausar)</li>
      </ul>
      <p>📱 No celular aparece controle virtual (toque).  
      ⚠️ Se existir <code>default.state</code> na pasta, ele é carregado automaticamente.</p>
    </div>
  </main>

  <footer><div class="wrap">ROM padrão: <code>smw.sfc</code> • Save inicial: <code>default.state</code></div></footer>

  <script>
    // Configuração base
    window.EJS_player = "#game";
    window.EJS_core = "snes";
    window.EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
    window.EJS_gameUrl = "smw.sfc";
    window.EJS_gameName = "Super Mario World";
    window.EJS_mobileControls = true; // ✅ ativa controles touch

    const LS_KEY = "snes_web_slot0_state";

    function startEmu(){
      const s = document.createElement("script");
      s.src = "https://cdn.emulatorjs.org/stable/data/loader.js";
      document.body.appendChild(s);
    }
    startEmu();

    // Alerta para girar o celular se estiver em retrato
    if(window.innerHeight > window.innerWidth){
      alert("📱 Dica: gire o celular para horizontal para jogar melhor!");
    }

    // Tenta carregar default.state
    async function loadDefaultState(){
      try {
        const resp = await fetch("default.state", { cache: "no-store" });
        if (!resp.ok) {
          alert("❌ Arquivo default.state não encontrado (HTTP " + resp.status + ")");
          return;
        }
        const buf = new Uint8Array(await resp.arrayBuffer());
        if (!buf.length) {
          alert("❌ default.state está vazio (0 bytes). Exporte um save válido.");
          return;
        }
        const apply = () => {
          const gm = window.EJS_emulator?.gameManager;
          if (!gm) return setTimeout(apply, 400);
          try {
            gm.setState ? gm.setState(buf) : gm.loadState(buf);
            alert("📥 Save inicial (default.state) carregado!");
          } catch (e) {
            alert("⚠️ Erro ao aplicar default.state. Reexporte o save.");
          }
        };
        apply();
      } catch (e) {
        alert("❌ Erro de rede ao buscar default.state. Abra pelo servidor (python -m http.server).");
      }
    }
    setTimeout(loadDefaultState, 4000);

    // Upload manual de ROM
    document.getElementById("romInput").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      const buf = await file.arrayBuffer();
      window.EJS_gameUrl = new Uint8Array(buf);
      window.EJS_gameName = file.name;
      if (window.EJS_terminate) { try { window.EJS_terminate(); } catch(e){} }
      startEmu();
      setTimeout(loadDefaultState, 3000);
    });

    // Botões de controle
    document.getElementById("btnPause").onclick = () => {
      const emu = window.EJS_emulator;
      if (!emu) return;
      emu.isPaused() ? emu.resume() : emu.pause();
    };
    document.getElementById("btnFullscreen").onclick = () => {
      const host = document.getElementById("gameHost");
      document.fullscreenElement ? document.exitFullscreen() : host.requestFullscreen().catch(()=>{});
    };

    // Save localStorage
    document.getElementById("btnSave").onclick = () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm?.getState) return alert("Jogo não iniciado");
      try {
        const state = gm.getState();
        localStorage.setItem(LS_KEY, btoa(String.fromCharCode(...state)));
        alert("✅ Save gravado no navegador!");
      } catch(e){ alert("Erro ao salvar"); }
    };

    document.getElementById("btnLoad").onclick = () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm) return alert("Jogo não iniciado");
      const b64 = localStorage.getItem(LS_KEY);
      if (!b64) return alert("Nenhum save encontrado no navegador");
      const u8 = new Uint8Array(atob(b64).split("").map(c=>c.charCodeAt(0)));
      try {
        gm.setState ? gm.setState(u8) : gm.loadState(u8);
        alert("📂 Save carregado do navegador!");
      } catch(e){ alert("Erro ao carregar"); }
    };

    // Exportar/importar
    document.getElementById("btnExport").onclick = () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm?.getState) return alert("Jogo não iniciado");
      try {
        const state = gm.getState();
        const blob = new Blob([state], {type:"application/octet-stream"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = (window.EJS_gameName || "snes") + ".state";
        a.click(); URL.revokeObjectURL(url);
      } catch(e){ alert("Erro ao exportar"); }
    };

    document.getElementById("btnImport").onclick = () =>
      document.getElementById("stateInput").click();
    document.getElementById("stateInput").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      const buf = new Uint8Array(await file.arrayBuffer());
      const gm = window.EJS_emulator?.gameManager;
      try {
        gm.setState ? gm.setState(buf) : gm.loadState(buf);
        alert("📥 Save importado");
      } catch(e){ alert("Erro ao importar"); }
    });
  </script>
</body>
</html>