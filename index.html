<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>SNES Web ‚Äì Super Mario World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <style>
    body {
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      background: #111;
      color: #eee;
      font: 15px/1.5 system-ui;
      text-align:center;
    }
    header,footer { padding:12px 16px; background:#222 }
    .wrap { max-width:980px; margin:0 auto; padding:16px }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:20px 0 }
    button,input[type=file] {
      background:#444; border:1px solid #666; color:#eee;
      padding:10px 14px; border-radius:6px; cursor:pointer; font-size:16px
    }
    button:hover { background:#555 }
    #gameHost {
      width: 100vw;
      height: calc(100vh - 260px); /* altura maior para deixar espa√ßo pros bot√µes */
      max-width: 100%;
      margin: 0 auto;
      background:#000;
      border-radius:8px;
      overflow:hidden;
      border:1px solid #333;
    }
    #game { width:100%; height:100% }
    .info { margin-top:20px; background:#1a1a1a; padding:12px; border-radius:8px; text-align:left }
    code { background:#333; padding:2px 5px; border-radius:4px }
    @media (max-width:768px){
      .toolbar{flex-direction:column}
      button,input[type=file]{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap"><strong>SNES Web ‚Äì Super Mario World</strong></div>
  </header>

  <main class="wrap">
    <!-- Tela do jogo -->
    <div id="gameHost"><div id="game"></div></div>

    <!-- Barra de bot√µes abaixo -->
    <div class="toolbar">
      <label>
        <input id="romInput" type="file" accept=".smc,.sfc,.zip,.7z" />
        Carregar ROM‚Ä¶
      </label>
      <button id="btnSave">üíæ Salvar (navegador)</button>
      <button id="btnLoad">üìÇ Carregar (navegador)</button>
      <button id="btnQuickSave" style="display:none">‚ö° Save r√°pido</button>
      <button id="btnExport">‚¨áÔ∏è Exportar Save</button>
      <button id="btnImport">‚¨ÜÔ∏è Importar Save</button>
      <input id="stateInput" type="file" accept=".state" style="display:none" />
      <button id="btnPause">‚èØÔ∏è Pausar</button>
      <button id="btnFullscreen">‚õ∂ Tela cheia</button>
    </div>

    <!-- Instru√ß√µes abaixo da barra -->
    <div class="info">
      <h3>üéÆ Controles</h3>
      <ul>
        <li>Direcionais: <code>Setas</code></li>
        <li>A / B / X / Y: <code>Z</code> / <code>X</code> / <code>A</code> / <code>S</code></li>
        <li>L / R: <code>Q</code> / <code>W</code></li>
        <li>Start: <code>Enter</code> &nbsp; Select: <code>Shift direito</code></li>
        <li>Atalhos: <code>F</code> (tela cheia), <code>P</code> (pausar)</li>
      </ul>
      <p>üì± No celular aparecem controles virtuais (toque).  
      ‚ö° Bot√£o de <b>Save r√°pido</b> aparece no celular e tamb√©m quando um controle for conectado.</p>
    </div>
  </main>

  <footer><div class="wrap">ROM padr√£o: <code>smw.sfc</code> ‚Ä¢ Save opcional: <code>default.state</code></div></footer>

  <script>
    // Configura√ß√£o base
    window.EJS_player = "#game";
    window.EJS_core = "snes";
    window.EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
    window.EJS_gameUrl = "smw.sfc";
    window.EJS_gameName = "Super Mario World";
    window.EJS_mobileControls = true;

    const LS_KEY = "snes_web_slot0_state";

    function startEmu(){
      const s = document.createElement("script");
      s.src = "https://cdn.emulatorjs.org/stable/data/loader.js";
      document.body.appendChild(s);
    }

    async function loadDefaultState(){
      try {
        const resp = await fetch("default.state", { cache: "no-store" });
        if (!resp.ok) return;
        const buf = new Uint8Array(await resp.arrayBuffer());
        if (!buf.length) return;
        const apply = () => {
          const gm = window.EJS_emulator?.gameManager;
          if (!gm) return setTimeout(apply, 400);
          try { gm.setState ? gm.setState(buf) : gm.loadState(buf); }
          catch (e) { console.warn("Save incompat√≠vel, ignorado."); }
        };
        apply();
      } catch (e) {
        console.warn("Erro ao tentar carregar default.state, ignorado.");
      }
    }

    // Auto-start ao abrir a p√°gina
    window.addEventListener("DOMContentLoaded", () => {
      startEmu();
      setTimeout(loadDefaultState, 3000);

      // Ativar bot√£o de save r√°pido no celular
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.getElementById("btnQuickSave").style.display = "inline-block";
      }
    });

    // Detectar controle conectado (Gamepad API)
    window.addEventListener("gamepadconnected", () => {
      document.getElementById("btnQuickSave").style.display = "inline-block";
    });

    // Helpers
    function u8ToB64(u8){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(new Blob([u8]));
      });
    }
    function b64ToU8(b64){
      const bin = atob(b64);
      const arr = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
      return arr;
    }

    // Upload manual de ROM
    document.getElementById("romInput").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      const buf = await file.arrayBuffer();
      window.EJS_gameUrl = new Uint8Array(buf);
      window.EJS_gameName = file.name;
      if (window.EJS_terminate) { try { window.EJS_terminate(); } catch(e){} }
      startEmu();
      setTimeout(loadDefaultState, 3000);
    });

    // Bot√µes
    document.getElementById("btnPause").onclick = () => {
      const emu = window.EJS_emulator;
      if (!emu) return;
      emu.isPaused() ? emu.resume() : emu.pause();
    };
    document.getElementById("btnFullscreen").onclick = () => {
      const host = document.getElementById("gameHost");
      if (host.requestFullscreen) host.requestFullscreen();
      else if (host.webkitRequestFullscreen) host.webkitRequestFullscreen();
    };

    // Save normal
    document.getElementById("btnSave").onclick = async () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm?.getState) return alert("Jogo n√£o iniciado");
      const state = gm.getState();
      const b64 = await u8ToB64(state);
      localStorage.setItem(LS_KEY, b64);
      alert("‚úÖ Save gravado no navegador!");
    };

    // Load normal
    document.getElementById("btnLoad").onclick = () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm) return alert("Jogo n√£o iniciado");
      const b64 = localStorage.getItem(LS_KEY);
      if (!b64) return alert("Nenhum save encontrado no navegador");
      const u8 = b64ToU8(b64);
      gm.setState ? gm.setState(u8) : gm.loadState(u8);
      alert("üìÇ Save carregado do navegador!");
    };

    // Save r√°pido (instant√¢neo)
    document.getElementById("btnQuickSave").onclick = async () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm?.getState) return alert("Jogo n√£o iniciado");
      const state = gm.getState();
      const b64 = await u8ToB64(state);
      localStorage.setItem(LS_KEY, b64);
      alert("‚ö° Save r√°pido gravado!");
    };

    // Exportar/importar
    document.getElementById("btnExport").onclick = () => {
      const gm = window.EJS_emulator?.gameManager;
      if (!gm?.getState) return alert("Jogo n√£o iniciado");
      const state = gm.getState();
      const blob = new Blob([state], {type:"application/octet-stream"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = (window.EJS_gameName || "snes") + ".state";
      a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById("btnImport").onclick = () =>
      document.getElementById("stateInput").click();
    document.getElementById("stateInput").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      const buf = new Uint8Array(await file.arrayBuffer());
      const gm = window.EJS_emulator?.gameManager;
      gm.setState ? gm.setState(buf) : gm.loadState(buf);
    });
  </script>
</body>
</html>